I"·7<p>ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë° ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì¥ì‹œê°„ ì‹¤í–‰ëœë‹¤. ìŠ¤íŒŒí¬ 
ìŠ¤íŠ¸ë¦¬ë°ì„ ì¢…ë£Œí•  ë•Œ ì–´ë–»ê²Œ í•˜ë©´ ì§„í–‰ ì¤‘ì¸ Jobì˜ ë©”ì‹œì§€ ì†ì‹¤ ì—†ì´ 
ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œ í•  ìˆ˜ ìˆì„ê¹Œ?</p>

<p><code class="language-plaintext highlighter-rouge">ë§Œì•½ ì‹¤í–‰ì¤‘ì¸ ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë° ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ê°•ì œë¡œ kill í•œë‹¤ë©´ 
ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë° íì—ì„œ ì§„í–‰ ì¤‘ì¸ jobì— ëŒ€í•œ ë°ì´í„°ê°€ ì†ì‹¤ë  ìˆ˜ ìˆë‹¤.</code></p>

<p>graceful í•˜ê²Œ ì¢…ë£Œí•˜ê¸° ì „ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•˜ì˜€ëŠ”ë° 
ë°ì´í„° ì†ì‹¤ì´ ìˆì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ yan application -kill [applicationId]
</code></pre></div></div>

<p>ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë°ì„ graceful í•˜ê²Œ ì¢…ë£Œ í• ìˆ˜ ìˆëŠ” ëª‡ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤.  <br />
<code class="language-plaintext highlighter-rouge">ì—¬ê¸°ì„œ graceful í•˜ê²Œ ì¢…ë£Œí•œë‹¤ëŠ” ì˜ë¯¸ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ shutdown signalì„ ë°›ê²Œ ë˜ë©´ 
ë”ì´ìƒ ì§„í–‰ì¤‘ì¸ ë°ì´í„° í”„ë¡œì„¸ì‹±ì„ ë°›ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•˜ë©° 
í˜„ì¬ê¹Œì§€ ì§„í–‰ì¤‘ì¸ ëª¨ë“  ë°ì´í„°ê¹Œì§€ëŠ” ì²˜ë¦¬í•˜ê³  ì¢…ë£Œ í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.</code></p>

<hr />

<h2 id="1-stopgracefullyonshutdown-parameter">1. stopGracefullyOnShutdown parameter</h2>

<p>ì²«ë²ˆì§¸ ë°©ë²•ì€ spark.streaming.stopGracefullyOnShutdown íŒŒë¼ë¯¸í„°ë¥¼ 
trueë¡œ ì£¼ëŠ” ë°©ë²•ì´ë‹¤.( default ëŠ” falseì´ë‹¤ )  <br />
ê°œë°œìê°€ ë”ì´ìƒ ì½”ë“œì—ì„œ ì§ì ‘ ssc.stop()ì„ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ë‹¤.
ëŒ€ì‹  SIGTERM ì‹ í˜¸ë¥¼ driverì—ê²Œ ë³´ë‚¸ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sparkConf.set(â€œspark.streaming.stopGracefullyOnShutdown","true") 
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ SIGTERMì´ë€ í”„ë¡œì„¸ì„œë¥¼ ì¤‘ì§€ì‹œí‚¤ëŠ” ì•ˆì „í•œ ë°©ë²•ì´ë‹¤. ë°˜ëŒ€ë¡œ 
SIGKILL ì‹ í˜¸ë¥¼ í”„ë¡œì„¸ìŠ¤ì—ê²Œ ë³´ë‚¸ë‹¤ë©´ ê·¸ í”„ë¡œì„¸ì„œëŠ” ë°”ë¡œ ì¤‘ë‹¨í•œë‹¤.</p>

<p>stopGracefullyOnShutdown íŒŒë¼ë¯¸í„°ë¥¼ trueë¡œ ì£¼ëŠ” ë°©ë²•ì€ 
ì•„ë˜ì™€ ê°™ì€ ìˆœì„œë¡œ ì§„í–‰ëœë‹¤.</p>

<ol>
  <li>
    <p>Spark UIë¥¼ ì´ìš©í•˜ì—¬ driver í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ì¤‘ì¸ ë…¸ë“œë¥¼ ì°¾ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>Driverê°€ ì‹¤í–‰ì¤‘ì¸ ì„œë²„ë¥¼ ì°¾ì•„ AMì˜ pidë¥¼ ì°¾ëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>kill -SIGTERM [AM-PID] ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ì— SIGTERM ì‹ í˜¸ë¥¼ ë³´ë‚¸ë‹¤.</p>
  </li>
</ol>

<p>Spark driverëŠ” SIGTERM ì‹ í˜¸ë¥¼ ë°›ì€ í›„ì— ë‹¤ìŒê³¼ ê°™ì€ ë¡œê·¸ ë©”ì‹œì§€ë¥¼ í™•ì¸ í• ìˆ˜ ìˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>17/02/02 01:31:35 ERROR yarn.ApplicationMaster: RECEIVED SIGNAL 15: SIGTERM

17/02/02 01:31:35 INFO streaming.StreamingContext: Invoking stop(stopGracefully=true) from shutdown hook

...

17/02/02 01:31:45 INFO streaming.StreamingContext: StreamingContext stopped successfully

17/02/02 01:31:45 INFO spark.SparkContext: Invoking stop() from shutdown hook

...

17/02/02 01:31:45 INFO spark.SparkContext: Successfully stopped SparkContext

...

17/02/02 01:31:45 INFO util.ShutdownHookManager: Shutdown hook called
</code></pre></div></div>

<hr />

<h2 id="2-implement-graceful-shutdown">2. implement graceful shutdown</h2>

<p>í•„ìì˜ ê²½ìš° í˜„ì¬ AWSë¥¼ ì´ìš©í•˜ì—¬ ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë°ì„ ë°°í¬í•˜ì—¬ ìš´ì˜í•˜ê³  
ìˆê³  Kinesis, EMR, S3, DynamoDB ë“±ì„ ê°™ì´ ì‚¬ìš©í•˜ê³  ìˆë‹¤.  <br />
ê·¸ë˜ì„œ S3ë¥¼ ì´ìš©í•˜ì—¬ checkpointì™€ ê°™ì´ ë§ˆì»¤ íŒŒì¼ì„ s3ì— ì €ì¥í•˜ê³  
graceful shutdownì„ ì§ì ‘ êµ¬í˜„í•˜ì˜€ë‹¤.</p>

<p><a href="https://medium.com/@manojkumardhakad/how-to-do-graceful-shutdown-of-spark-streaming-job-9c910770349c">ë§í¬</a>ë¥¼ ì°¸ê³ í•˜ì˜€ìœ¼ë©° 
ì§„í–‰ ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<ul>
  <li>ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë°ì„ ì‹œì‘í•œ í›„ S3(checkpoint directory)ì— í˜„ì¬ ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë°ì„ 
êµ¬ë¶„í•  ìˆ˜ ìˆëŠ” ì´ë¦„ì„ ê°€ì§„ í•˜ë‚˜ì˜ íŒŒì¼(ë§ˆì»¤)ì„ ìƒì„±í•œë‹¤.</li>
</ul>

<blockquote>
  <p>ì´ ê¸€ì—ì„œëŠ” S3ì— ë§ˆì»¤ë¥¼ ì €ì¥í–ˆì§€ë§Œ, ìƒí™©ì— ë”°ë¼ hdfs, redis ë“±ì„ ì´ìš©í•´ë„ ëœë‹¤.</p>
</blockquote>

<ul>
  <li>
    <p>í˜„ì¬ ì§„í–‰ì¤‘ì¸ ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë°ì˜ DriverëŠ” ì§€ì†ì ìœ¼ë¡œ ì§€ì •ëœ ìœ„ì¹˜ì˜ íŒŒì¼ì´ 
ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ gracefullyí•˜ê²Œ ì¢…ë£Œí•˜ë ¤ë©´, S3ì— ì €ì¥í•œ íŒŒì¼ì„ ì‚­ì œí•˜ë©´ ëœë‹¤. ê·¸ëŸ¬ë©´ 
í˜„ì¬ ì²˜ë¦¬ ë°°ì¹˜ì™€ íì— ì§„í–‰ì¤‘ì¸ ë°°ì¹˜ê¹Œì§€ ì™„ë£Œí•œ í›„ì—ë§Œ ì‘ì—…ì´ ì¤‘ì§€ë˜ë¯€ë¡œ 
ë°ì´í„°ê°€ ì†ì‹¤ë˜ì§€ ì•ŠëŠ”ë‹¤.</code></p>
  </li>
</ul>

<p>ì•„ë˜ ì½”ë“œë¥¼ ì‚´í´ë³´ì.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">GracefulShutdownExample</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">s3Bucket</span> <span class="k">=</span> <span class="s">"s3-example"</span>
  <span class="k">val</span> <span class="nv">shutdownPrefix</span> <span class="k">=</span> <span class="s">"flag/marker"</span>
  <span class="k">var</span> <span class="n">stopFlag</span> <span class="k">=</span> <span class="kc">false</span>
  <span class="k">def</span> <span class="nf">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">conf</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkConf</span><span class="o">().</span><span class="py">setAppName</span><span class="o">(</span><span class="s">"SparkStreamingGracefulShutdown"</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">sparkConext</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkConext</span><span class="o">(</span><span class="n">conf</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">appId</span> <span class="k">=</span> <span class="nv">sparkConext</span><span class="o">.</span><span class="py">applicationId</span> <span class="c1">// í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ app id</span>

    <span class="k">val</span> <span class="nv">ssc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingContext</span><span class="o">(</span><span class="n">conf</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">(</span><span class="mi">5</span><span class="o">))</span>
    <span class="k">val</span> <span class="nv">lines</span> <span class="k">=</span> <span class="nv">ssc</span><span class="o">.</span><span class="py">socketTextStream</span><span class="o">(</span><span class="s">"ljiang-spark-1.vpc.cloudera.com"</span><span class="o">,</span> <span class="mi">9999</span><span class="o">)</span>
    <span class="nv">lines</span><span class="o">.</span><span class="py">print</span><span class="o">()</span>

    <span class="nv">ssc</span><span class="o">.</span><span class="py">start</span><span class="o">()</span>

    <span class="nv">S3Util</span><span class="o">.</span><span class="py">createFlag</span><span class="o">(</span><span class="n">s3Bucket</span><span class="o">,</span> <span class="n">shutdownPrefix</span><span class="o">/</span><span class="n">appId</span><span class="o">,</span> <span class="s">"shutdown flag"</span><span class="o">)</span> <span class="c1">// s3ì— ì• í”Œë¦¬ì¼€ì´ì…˜idë¥¼ ì €ì¥   </span>
    <span class="k">val</span> <span class="nv">checkIntervalMillis</span> <span class="k">=</span> <span class="mi">10000</span>
    <span class="k">var</span> <span class="n">isStopped</span> <span class="k">=</span> <span class="kc">false</span>

    <span class="nf">while</span> <span class="o">(!</span> <span class="n">isStopped</span><span class="o">)</span> <span class="o">{</span>
      <span class="nf">println</span><span class="o">(</span><span class="s">"calling awaitTerminationOrTimeout"</span><span class="o">)</span>
      <span class="n">isStopped</span> <span class="k">=</span> <span class="nv">ssc</span><span class="o">.</span><span class="py">awaitTerminationOrTimeout</span><span class="o">(</span><span class="n">checkIntervalMillis</span><span class="o">)</span>
      <span class="nf">if</span> <span class="o">(</span><span class="n">isStopped</span><span class="o">)</span>
        <span class="nf">println</span><span class="o">(</span><span class="s">"confirmed! The streaming context is stopped. Exiting application..."</span><span class="o">)</span>
      <span class="k">else</span>
        <span class="nf">println</span><span class="o">(</span><span class="s">"Streaming App is still running. Timeout..."</span><span class="o">)</span>

      <span class="nf">checkShutdownMarker</span><span class="o">(</span><span class="n">appId</span><span class="o">)</span> <span class="c1">// s3ì— shutdown ë§ˆì»¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸   </span>
      <span class="nf">if</span> <span class="o">(!</span><span class="n">isStopped</span> <span class="o">&amp;&amp;</span> <span class="n">stopFlag</span><span class="o">)</span> <span class="o">{</span>
        <span class="nf">println</span><span class="o">(</span><span class="s">"stopping ssc right now"</span><span class="o">)</span>
        <span class="nv">ssc</span><span class="o">.</span><span class="py">stop</span><span class="o">(</span><span class="n">sparkConext</span> <span class="k">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">stopGracefully</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span>

        <span class="nf">println</span><span class="o">(</span><span class="s">"ssc is stopped!!!!!!!"</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">checkShutdownMarker</span><span class="o">(</span><span class="n">appId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(!</span><span class="n">stopFlag</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">shutdownMarkers</span> <span class="k">=</span> <span class="nv">S3Util</span><span class="o">.</span><span class="py">getS3ObjectKey</span><span class="o">(</span><span class="n">s3Bucket</span><span class="o">,</span> <span class="n">shutdownPrefix</span><span class="o">)</span> <span class="c1">// S3ì—ì„œ í•´ë‹¹ ê²½ë¡œì˜ íŒŒì¼ë“¤ì„ ëª¨ë‘ ê°€ì ¸ì˜¨ë‹¤.   </span>
      <span class="n">stopFlag</span> <span class="k">=</span> <span class="nv">shutdownMarkers</span><span class="o">.</span><span class="py">exists</span><span class="o">(</span><span class="n">appId</span><span class="o">)</span> <span class="c1">// í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë° ì–´í”„ë¦¬ì¼€ì´ì…˜ì„ appIdë¡œ í™•ì¸    </span>
    <span class="o">}</span>

  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>scc.stop(true, true)ì—ì„œ ì²«ë²ˆì§¸ trueê°€ ì˜ë¯¸í•˜ëŠ” ê²ƒì€ spark conextê°€ 
ì¤‘ì§€ ë˜ëŠ” ê²ƒì„ ì˜ë¯¸í•˜ë©°, ë‘ë²ˆì§¸ trueê°€ ì˜ë¯¸í•˜ëŠ” ê²ƒì€ graceful shutdownì„ 
ì˜ë¯¸í•œë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">ì£¼ì˜í•  ì ì€ stopë¥¼ Batchì²˜ë¦¬í•˜ëŠ” ì½”ë“œ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í•˜ë©´ deadlockì„ 
ë°œìƒì‹œí‚¬ìˆ˜ ìˆìœ¼ë¯€ë¡œ Driverì—ì„œ ì²˜ë¦¬ í• ìˆ˜ ìˆë„ë¡ í•˜ì.</code></p>

<hr />

<h2 id="ì •ë¦¬">ì •ë¦¬</h2>

<p>ì§€ê¸ˆê¹Œì§€ ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë°ì„ ë°ì´í„° ì†ì‹¤ ì—†ì´ ì¢…ë£Œ í•˜ëŠ” ë°©ë²•ì„ 
ì•Œì•„ ë´¤ë‹¤. ë§Œì•½ í”„ë¡œê·¸ë¨ ìˆ˜ì •ì´ í•„ìš”í•˜ì—¬ ê°€ì¥ ìµœê·¼ ë²„ì „ìœ¼ë¡œ 
ë¹Œë“œëœ jaríŒŒì¼ë¡œ ë³€ê²½í•´ì•¼ í•  ë•ŒëŠ”  ìŠ¤íŒŒí¬ ìŠ¤íŠ¸ë¦¬ë°ì„ gracefulí•˜ê²Œ ì¢…ë£Œí•˜ê³  
ê°€ì¥ ìµœê·¼ì— ë¹Œë“œëœ jaríŒŒì¼ë¡œ ë‹¤ì‹œ ì‹œì‘ì„ í•˜ë©´ëœë‹¤.</p>

<p>gracefulí•˜ê²Œ ì¢…ë£Œí•˜ì—¬ ë°ì´í„° ì†ì‹¤ì„ ë§‰ê¸°ëŠ” í–ˆì§€ë§Œ 
ë‹¤ìš´íƒ€ì„ì´ ì¡´ì¬í•œë‹¤ëŠ” ë‹¨ì ì´ ìˆê¸° ë•Œë¬¸ì— ë¬´ì¤‘ë‹¨ìœ¼ë¡œ 
ë°°í¬í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆëŠ”ì§€ ì•Œì•„ë´ì•¼ í•  ê²ƒ ê°™ë‹¤.</p>

<hr />

<p><strong>Reference</strong></p>

<p><a href="http://why-not-learn-something.blogspot.com/2016/05/apache-spark-streaming-how-to-do.html">http://why-not-learn-something.blogspot.com/2016/05/apache-spark-streaming-how-to-do.html</a><br />
<a href="https://www.linkedin.com/pulse/how-shutdown-spark-streaming-job-gracefully-lan-jiang/">https://www.linkedin.com/pulse/how-shutdown-spark-streaming-job-gracefully-lan-jiang/</a><br />
<a href="https://medium.com/@manojkumardhakad/how-to-do-graceful-shutdown-of-spark-streaming-job-9c910770349c">https://medium.com/@manojkumardhakad/how-to-do-graceful-shutdown-of-spark-streaming-job-9c910770349c</a><br />
<a href="https://github.com/lanjiang/streamingstopgraceful/blob/master/src/main/scala/com/cloudera/ps/GracefulShutdownExample.scala">https://github.com/lanjiang/streamingstopgraceful/blob/master/src/main/scala/com/cloudera/ps/GracefulShutdownExample.scala</a></p>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://zcx6263.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

:ET